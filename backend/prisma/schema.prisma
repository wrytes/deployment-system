// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String        @id @default(cuid())
  telegramId      BigInt        @unique @map("telegram_id")
  telegramHandle  String?       @map("telegram_handle")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Notification preferences
  notifyEnvironmentActive      Boolean  @default(true) @map("notify_environment_active")
  notifyEnvironmentDeleted     Boolean  @default(true) @map("notify_environment_deleted")
  notifyEnvironmentMadePublic  Boolean  @default(true) @map("notify_environment_made_public")
  notifyDeploymentStarted      Boolean  @default(true) @map("notify_deployment_started")
  notifyDeploymentSuccess      Boolean  @default(true) @map("notify_deployment_success")
  notifyDeploymentStopped      Boolean  @default(true) @map("notify_deployment_stopped")
  notifyErrors                 Boolean  @default(true) @map("notify_errors")

  apiKeys         ApiKey[]
  environments    Environment[]
  magicLinks      MagicLink[]

  @@map("users")
}

enum ApiKeyScope {
  ENVIRONMENTS_READ
  ENVIRONMENTS_WRITE
  DEPLOYMENTS_READ
  DEPLOYMENTS_WRITE
  LOGS_READ
  ADMIN
}

model ApiKey {
  id          String         @id @default(cuid())
  userId      String         @map("user_id")
  keyId       String         @unique @map("key_id") // 16-char identifier
  secretHash  String         @map("secret_hash")    // bcrypt hash of secret
  scopes      ApiKeyScope[]  @default([ENVIRONMENTS_READ, DEPLOYMENTS_READ, LOGS_READ])
  expiresAt   DateTime?      @map("expires_at")
  revokedAt   DateTime?      @map("revoked_at")
  lastUsedAt  DateTime?      @map("last_used_at")
  createdAt   DateTime       @default(now()) @map("created_at")

  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyId])
  @@map("api_keys")
}

enum EnvironmentStatus {
  CREATING
  ACTIVE
  DELETING
  DELETED
  ERROR
}

model Environment {
  id                String              @id @default(cuid())
  userId            String              @map("user_id")
  name              String
  overlayNetworkId  String              @unique @map("overlay_network_id") // overlay_env_{name}_{timestamp}
  dockerNetworkId   String?             @map("docker_network_id")          // Docker's internal network ID
  status            EnvironmentStatus   @default(CREATING)
  isPublic          Boolean             @default(false) @map("is_public")
  errorMessage      String?             @map("error_message")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  deployments       Deployment[]

  @@unique([userId, name])
  @@index([userId])
  @@index([status])
  @@map("environments")
}

enum DeploymentStatus {
  PENDING
  PULLING_IMAGE
  CREATING_VOLUMES
  STARTING_CONTAINERS
  RUNNING
  FAILED
  STOPPED
}

enum DeploymentUpdateStrategy {
  IN_PLACE        // service.update()
  BLUE_GREEN      // Create new, cutover, cleanup
}

enum DeploymentUpdateStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  ROLLED_BACK
}

model Deployment {
  id              String            @id @default(cuid())
  environmentId   String            @map("environment_id")
  jobId           String            @unique @map("job_id") // 16-char identifier for polling
  image           String                                   // e.g., "nginx"
  tag             String            @default("latest")     // e.g., "latest", "1.21"
  replicas        Int               @default(1)
  ports           Json?                                    // [{container: 80, host: 8080, protocol: "tcp"}]
  envVars         Json?             @map("env_vars")       // {KEY: "value"}
  volumes         Json?                                    // [{name: "data", path: "/data"}]
  virtualHost     String?           @map("virtual_host")   // Domain for public access (e.g., "api.example.com")
  virtualPort     Int?              @map("virtual_port")   // Container port to expose (e.g., 80, 3000)
  status          DeploymentStatus  @default(PENDING)
  errorMessage    String?           @map("error_message")
  startedAt       DateTime?         @map("started_at")
  completedAt     DateTime?         @map("completed_at")
  createdAt       DateTime          @default(now()) @map("created_at")
  currentVersion  Int               @default(1) @map("current_version")

  // Git deployment tracking
  gitUrl          String?           @map("git_url")
  gitBranch       String?           @map("git_branch")
  gitCommitSha    String?           @map("git_commit_sha")
  autoRebuild     Boolean           @default(false) @map("auto_rebuild")

  environment     Environment       @relation(fields: [environmentId], references: [id], onDelete: Cascade)
  service         Service?
  versions        DeploymentVersion[]
  updates         DeploymentUpdate[]

  @@index([environmentId])
  @@index([jobId])
  @@index([status])
  @@index([virtualHost])
  @@map("deployments")
}

enum ServiceStatus {
  CREATING
  RUNNING
  STOPPED
  FAILED
}

enum HealthStatus {
  HEALTHY
  UNHEALTHY
  STARTING
  NONE
}

model Service {
  id            String        @id @default(cuid())
  deploymentId  String        @unique @map("deployment_id")
  dockerId      String?       @unique @map("docker_id")     // Docker's service ID
  name          String                                      // Service name in swarm
  status        ServiceStatus @default(CREATING)
  healthStatus  HealthStatus  @default(NONE) @map("health_status")
  restartCount  Int           @default(0) @map("restart_count")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  deployment    Deployment    @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@index([dockerId])
  @@map("services")
}

model MagicLink {
  id        String         @id @default(cuid())
  userId    String         @map("user_id")
  token     String         @unique                           // 32-char random token
  scopes    ApiKeyScope[]  @default([ENVIRONMENTS_READ, DEPLOYMENTS_READ, LOGS_READ])
  expiresAt DateTime       @map("expires_at")               // 15 minutes expiry
  usedAt    DateTime?      @map("used_at")
  createdAt DateTime       @default(now()) @map("created_at")

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("magic_links")
}

// Track deployment configuration history
model DeploymentVersion {
  id               String            @id @default(cuid())
  deploymentId     String            @map("deployment_id")
  version          Int               // 1, 2, 3...
  image            String
  tag              String
  replicas         Int
  ports            Json?
  envVars          Json?             @map("env_vars")
  volumes          Json?
  createdAt        DateTime          @default(now()) @map("created_at")
  createdBy        String?           @map("created_by")

  deployment       Deployment        @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@unique([deploymentId, version])
  @@index([deploymentId])
  @@map("deployment_versions")
}

// Track update operations
model DeploymentUpdate {
  id                 String                      @id @default(cuid())
  deploymentId       String                      @map("deployment_id")
  fromVersion        Int                         @map("from_version")
  toVersion          Int                         @map("to_version")
  updateStrategy     DeploymentUpdateStrategy    @map("update_strategy")
  status             DeploymentUpdateStatus      @default(PENDING)
  changes            Json                        // What changed
  errorMessage       String?                     @map("error_message")
  startedAt          DateTime?                   @map("started_at")
  completedAt        DateTime?                   @map("completed_at")
  createdAt          DateTime                    @default(now()) @map("created_at")

  deployment         Deployment                  @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@index([deploymentId])
  @@index([status])
  @@map("deployment_updates")
}
